{"ast":null,"code":"import request from 'superagent';\nimport { each, keys, some, extend, isObject } from 'underscore';\nimport mockServer from '../lib/mock/MockServer';\nimport ServerError from '../lib/errors/ServerError';\nimport config from '../config';\nconst notImplementedTemplates = ['/appointments' // '/clients'\n]; // срабатывает в случае успешной отработки сервера\n\nfunction onSuccess(response) {\n  let parsed = {}; // парсим JSON-строку ответа сервера вручную\n\n  try {\n    parsed = JSON.parse(response.text);\n  } catch (e) {\n    throw {\n      status: 'Response parse error',\n      body: response.body\n    };\n  }\n\n  const body = parsed.body;\n  const status = parsed.statusCode; // отсечём лишние данные из ответа сервера\n\n  if ((status === 200 || status === 201) && body.success !== false) {\n    return body;\n  }\n\n  throw new ServerError({\n    status,\n    ...body.error\n  });\n} // срабатывает в случае сбоя на сервере (сервер мёртв, не отвечает и пр.),\n// а не просто ошибки в серверной бизнес-логике.\n\n\nfunction onFailure(response) {\n  const {\n    status,\n    message,\n    response: {\n      body\n    }\n  } = response;\n  throw new ServerError({\n    body,\n    status,\n    code: 'internal.server.error',\n    message: body.message || message\n  });\n}\n\nexport default class BaseService {\n  request(opts) {\n    opts = {\n      method: 'GET',\n      url: null,\n      body: null,\n      type: 'form',\n      params: null,\n      callback: null,\n      ...opts\n    };\n    const {\n      remote\n    } = config; // проверяем, реализован ли на сервере данный API\n\n    const isNotImplemented = some(notImplementedTemplates, t => {\n      return opts.url.includes(t);\n    });\n\n    if (!remote.isEnabled || isNotImplemented) {\n      return mockServer.service({\n        method: 'GET',\n        url: null,\n        body: null,\n        params: null,\n        ...opts\n      }).then(onSuccess);\n    } else {\n      const {\n        type,\n        method\n      } = opts;\n      const url = `${remote.url}${opts.url}`;\n\n      if (method === 'GET') {\n        let rq = request.get(url).query(opts.params).timeout({\n          response: config.responseTimeout\n        });\n        const {\n          headers\n        } = opts;\n\n        if (headers) {\n          each(keys(headers), key => {\n            rq.set(key, headers[key]);\n          });\n        }\n\n        return rq.then(onSuccess, onFailure);\n      }\n\n      if (method === 'POST' || method === 'PUT') {\n        let rq = request(method, url).type(type).timeout({\n          response: config.responseTimeout\n        });\n\n        if (type === 'multipart/form-data') {\n          each(opts.body, (v, k) => {\n            if (v instanceof File) {\n              rq = rq.attach(k, v);\n            } else {\n              if (isObject(v)) {\n                v = JSON.stringify(v);\n              }\n\n              rq = rq.field(k, v);\n            }\n          });\n        } else {\n          rq = rq.send(opts.body);\n        }\n\n        return rq.then(onSuccess, onFailure);\n      }\n\n      if (method === 'DELETE') {\n        return request.del(url).timeout({\n          response: config.responseTimeout\n        }).then(onSuccess, onFailure);\n      }\n    }\n  }\n\n}","map":{"version":3,"sources":["E:/Git/Work/SynodalLegalDedartament3.0/my-app/src/services/BaseService.js"],"names":["request","each","keys","some","extend","isObject","mockServer","ServerError","config","notImplementedTemplates","onSuccess","response","parsed","JSON","parse","text","e","status","body","statusCode","success","error","onFailure","message","code","BaseService","opts","method","url","type","params","callback","remote","isNotImplemented","t","includes","isEnabled","service","then","rq","get","query","timeout","responseTimeout","headers","key","set","v","k","File","attach","stringify","field","send","del"],"mappings":"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","sourcesContent":["import request from 'superagent'\r\n\r\nimport {\r\n    each,\r\n    keys,\r\n    some,\r\n    extend,\r\n    isObject\r\n} from 'underscore'\r\n\r\nimport mockServer from '../lib/mock/MockServer'\r\nimport ServerError from '../lib/errors/ServerError'\r\n\r\nimport config from '../config'\r\n\r\nconst notImplementedTemplates = [\r\n    '/appointments',\r\n    // '/clients'\r\n]\r\n\r\n// срабатывает в случае успешной отработки сервера\r\nfunction onSuccess(response) {\r\n    let parsed = {}\r\n\r\n// парсим JSON-строку ответа сервера вручную\r\n    try {\r\n        parsed = JSON.parse(response.text)\r\n    } catch (e) {\r\n        throw {\r\n            status: 'Response parse error',\r\n            body: response.body\r\n        }\r\n    }\r\n\r\n    const body = parsed.body\r\n    const status = parsed.statusCode\r\n\r\n    // отсечём лишние данные из ответа сервера\r\n    if ((status === 200 || status === 201) && body.success !== false) {\r\n        return body\r\n    }\r\n\r\n    throw new ServerError({ status, ...body.error })\r\n}\r\n\r\n// срабатывает в случае сбоя на сервере (сервер мёртв, не отвечает и пр.),\r\n// а не просто ошибки в серверной бизнес-логике.\r\nfunction onFailure(response) {\r\n    const {\r\n        status,\r\n        message,\r\n        response: { body }\r\n    } = response\r\n\r\n    throw new ServerError({\r\n        body,\r\n        status,\r\n        code: 'internal.server.error',\r\n        message: body.message || message\r\n    })\r\n}\r\n\r\nexport default class BaseService {\r\n    request(opts) {\r\n\r\n        opts = {\r\n            method: 'GET',\r\n            url: null,\r\n            body: null,\r\n            type: 'form',\r\n            params: null,\r\n            callback: null,\r\n            ...opts\r\n        }\r\n\r\n        const { remote } = config\r\n\r\n        // проверяем, реализован ли на сервере данный API\r\n        const isNotImplemented = some(notImplementedTemplates, t => {\r\n            return opts.url.includes(t)\r\n        })\r\n\r\n        if (!remote.isEnabled || isNotImplemented) {\r\n            return mockServer.service({\r\n                method: 'GET',\r\n                url: null,\r\n                body: null,\r\n                params: null,\r\n                ...opts\r\n            }).then(onSuccess)\r\n        }\r\n\r\n        else {\r\n            const { type, method } = opts\r\n            const url = `${remote.url}${opts.url}`\r\n\r\n            if (method === 'GET') {\r\n                let rq = request.get(url)\r\n                    .query(opts.params)\r\n                    .timeout({response: config.responseTimeout})\r\n\r\n                const {headers} = opts\r\n                if (headers) {\r\n                    each(keys(headers), key => {\r\n                        rq.set(key, headers[key])\r\n                    })\r\n                }\r\n\r\n                return rq.then(onSuccess, onFailure)\r\n            }\r\n\r\n            if (method === 'POST' || method === 'PUT') {\r\n                let rq = request(method, url).type(type)\r\n                    .timeout({response: config.responseTimeout})\r\n\r\n                if (type === 'multipart/form-data') {\r\n                    each(opts.body, (v, k) => {\r\n                        if (v instanceof File) {\r\n                            rq = rq.attach(k, v)\r\n                        }\r\n\r\n                        else {\r\n                            if (isObject(v)) {\r\n                                v = JSON.stringify(v)\r\n                            }\r\n                            rq = rq.field(k, v)\r\n                        }\r\n                    })\r\n                } else {\r\n                    rq = rq.send(opts.body)\r\n                }\r\n\r\n                return rq.then(onSuccess, onFailure)\r\n            }\r\n\r\n            if (method === 'DELETE') {\r\n                return request\r\n                    .del(url)\r\n                    .timeout({response: config.responseTimeout})\r\n                    .then(onSuccess, onFailure)\r\n            }\r\n        }\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}